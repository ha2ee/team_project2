<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.orders">

<select id="selectLatestOrderAsk" parameterType="map" resultType="map"> 
  <![CDATA[  

SELECT ad.*, NVL(to_char(asks_regdate,'YYYY-MM-DD HH24:MI:SS'),0) ASKS_REGDATE1
FROM(
  SELECT * 
  FROM(
    SELECT * 
    FROM(
      SELECT ASKS.*,ORDERS.*
      FROM ORDERS
      left JOIN ASKS
      ON ORDERS.ORDERS_ASK_IDX = ASKS.ASKS_IDX)
    WHERE ASKS_PRODUCT_ID = #{product_id1})
  WHERE ROWNUM =1) ad
right OUTER JOIN DUAL
on asks_product_id = #{product_id2}
 ]]>
</select> 


<select id="selectLatestOrderBid" parameterType="map" resultType="map"> 
  <![CDATA[  

SELECT ad.*, NVL(to_char(bids_regdate,'YYYY-MM-DD HH24:MI:SS'),0) BIDS_REGDATE1
FROM(
  SELECT * 
  FROM(
    SELECT * 
    FROM(
      SELECT BIDS.*,ORDERS.*
      FROM ORDERS
      left JOIN BIDS
      ON ORDERS.ORDERS_BID_IDX = BIDS.BIDS_IDX)
    WHERE BIDS_PRODUCT_ID = #{product_id1})
  WHERE ROWNUM =1) ad
right OUTER JOIN DUAL
on BIDs_product_id = #{product_id2}
 ]]>
</select> 

<select id="selectLatestOrderReal" resultType="map"> 
  <![CDATA[  
    SELECT * 
    FROM (
        SELECT *
        FROM
            (SELECT *
            FROM 
                (SELECT ASKS.*,ORDERS.*
                 FROM ORDERS
                 left JOIN ASKS
                 ON ORDERS.ORDERS_ASK_IDX = ASKS.ASKS_IDX
                 ) A
            LEFT JOIN BIDS B
            ON A.ORDERS_BID_IDX = B.BIDS_IDX)
        ORDER BY ASKS_PRICE)
    WHERE ROWNUM = 1;
  ]]>
</select> 

<select id="selectForChart" resultType="map"> 
  <![CDATA[  
SELECT z2.matched_date,z2.price
FROM (
  SELECT z1.asks_price PRICE,z1.asks_matched_date MATCHED_DATE
  FROM (
    select o1.orders_ask_idx,A1.ASKS_PRICE,A1.ASKS_MATCHED_DATE,A1.ASKS_PRODUCT_ID
    from orders O1
    left join asks A1
    on O1.orders_ask_idx = A1.asks_idx) Z1
  WHERE ASKS_PRODUCT_ID = #{product_id1}

  UNION

  SELECT z1.BIDS_price PRICE,z1.BIDS_matched_date MATCHED_DATE  
  FROM (
    select o1.orders_BID_idx,B1.BIDS_PRICE,B1.BIDS_MATCHED_DATE,B1.BIDS_PRODUCT_ID
    from orders O1
    left join BIDS B1
    on o1.orders_bid_idx = B1.BIDS_idx) Z1
  WHERE BIDS_PRODUCT_ID = #{product_id2}
) z2
ORDER BY MATCHED_DATE
  ]]>
</select> 

</mapper>